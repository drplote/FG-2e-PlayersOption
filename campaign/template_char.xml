<?xml version="1.0" encoding="iso-8859-1"?>
<root>

  <template name="button_charinitdelay" merge="replace">
    <buttoncontrol>
      <icon normal="button_initdelay" pressed="button_initdelay_down" />
      <script>

        function onInit()
          OptionsManager.registerCallback(PlayerOptionManager.sPhasedInitiativeOptionKey, initMenuItems);
          initMenuItems();
        end

        function initMenuItems()
            resetMenuItems();
            if not PlayerOptionManager.isUsingPhasedInitiative() then
              registerMenuItem(Interface.getString("delay10_menuitem"), "delayTurn10ButtonIcon", 1);
              registerMenuItem(Interface.getString("delay1_menuitem"), "delayTurn1ButtonIcon", 2);
              registerMenuItem(Interface.getString("delay2_menuitem"), "delayTurn2ButtonIcon", 3);
              registerMenuItem(Interface.getString("delay3_menuitem"), "delayTurn3ButtonIcon", 4);
              registerMenuItem(Interface.getString("delay4_menuitem"), "delayTurn4ButtonIcon", 5);
              registerMenuItem(Interface.getString("delay5_menuitem"), "delayTurn5ButtonIcon", 6);
              registerMenuItem(Interface.getString("delay6_menuitem"), "delayTurn6ButtonIcon", 7);
              registerMenuItem(Interface.getString("delay7plus_menuitem"), "delayTurnButtonIcon", 8);
              registerMenuItem(Interface.getString("delay7_menuitem"), "delayTurn7ButtonIcon", 8, 1);
              registerMenuItem(Interface.getString("delay8_menuitem"), "delayTurn8ButtonIcon", 8, 2);
              registerMenuItem(Interface.getString("delay9_menuitem"), "delayTurn9ButtonIcon", 8, 3);
            end
        end

        function onMenuSelection(selection, subselection)
          if not PlayerOptionManager.isUsingPhasedInitiative() then
            local nodeChar = window.getDatabaseNode();
            if selection == 1 then
              action();
            elseif selection == 2 then
              InitManagerPO.tryDelayActor(nodeChar, 1);
            elseif selection == 3 then
              InitManagerPO.tryDelayActor(nodeChar, 2);
            elseif selection == 4 then
              InitManagerPO.tryDelayActor(nodeChar, 3);
            elseif selection == 5 then
              InitManagerPO.tryDelayActor(nodeChar, 4);
            elseif selection == 6 then
              InitManagerPO.tryDelayActor(nodeChar, 5);
            elseif selection == 7 then
              InitManagerPO.tryDelayActor(nodeChar, 6);
            elseif selection == 8 and subselection == 1 then
              InitManagerPO.tryDelayActor(nodeChar, 7);
            elseif selection == 8 and subselection == 2 then
              InitManagerPO.tryDelayActor(nodeChar, 8);
            elseif selection == 8 and subselection == 3 then
              InitManagerPO.tryDelayActor(nodeChar, 9);
            end
          else
            super.onMenuSelection(selection, subselection);
          end
        end

        function action(draginfo)
          local nodeChar = window.getDatabaseNode();
          if PlayerOptionManager.isUsingHackmasterInitiative() then
            InitManagerPO.tryDelayActor(nodeChar, 10);
          else
            local nodeCT = CombatManager.getCTFromNode(nodeChar);
            local nodeCTActive = CombatManager.getActiveCT();
            if nodeCT == nodeCTActive then
              local nLastInit = CombatManagerADND.getLastInitiative();
              CombatManagerADND.showCTMessageADND(nodeEntry,DB.getValue(nodeCT,"name","") .. " " .. Interface.getString("char_initdelay_message"));
              if Session.IsHost then 
                CombatManager.nextActor();
              else 
                CombatManager.notifyEndTurn();
              end
              CombatManagerADND.notifyInitiativeChange(nodeCT,nLastInit + 1);
            end
          end
          return true;
        end
        
        function onDragStart(button, x, y, draginfo)
          return action(draginfo);
        end
        
        function onDoubleClick(x,y)
          return action();
        end
      </script>
      <frame name="fielddark" offset="7,5,7,5" />
      <stateframe>
        <hover name="rowshade" offset="7,5,7,5" />
      </stateframe>
      <tooltip textres="char_initdelay_tooltip" />
    </buttoncontrol>
  </template>

</root>